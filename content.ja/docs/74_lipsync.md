---
title: 外部音声のリップシンク
slug: lipsync
---
{{< hint info >}}
外部音声のリップシンクの機能は Plugin_Remote が提供しています。利用時はこのプラグインが有効になっているか確かめてください。
{{< /hint >}}

# 外部音声のリップシンク

内蔵の音声合成モジュールではなく [サブモジュール](../submodule)や[ソケット接続](../remote-control) 等を用いて外部プロセスで音声合成（あるいは録音）を行う場合、それを MMDAgent-EX のキャラクターにリップシンクさせながら再生したいことがあります。

以下にいくつか方法を説明します。

## 方法１：ファイルに保存してリップシンク付き再生させる

音声合成（あるいは録音）内容をオーディオファイルとして保存し、そのファイルを MMDAgent-EX にリップシンク付き再生する方法です。ファイルを生成して保存したあと、そのパスを指定した **SPEAK** コマンドを送信することで MMDAgent-EX でリップシンク付き再生させます。

詳しい手順は[「サウンドを再生する」で説明しています。](../sound/#%e9%9f%b3%e5%a3%b0%e5%86%8d%e7%94%9f-with-%e3%83%aa%e3%83%83%e3%83%97%e3%82%b7%e3%83%b3%e3%82%af) 音声データは 16kHz, 16bit モノラルの .wav ファイルとして保存する必要があります。リップシンク内容は MMDAgent-EX にお任せになります。

外部プロセスから見たこの方法のメリット・デメリットです。

メリット：

- リップシンク情報を作る必要が無い
- 音声ファイルに保存してコマンドを送るだけなので簡単

デメリット：

- 16kHz, 16bit モノラルの音声データにしか対応していない
- リップシンクが正確でないことがある（音声から音素認識で抽出するので）
- 日本語以外に対応できない（音素認識が日本語なので）
- プロセス間のファイルアクセスの問題：同一マシン内で動かす必要がある
- 再生デバイスを選べない（既定のデバイスのみ）

## 方法２：口パクさせる

外部プロセス側で音声の再生までを一貫して行い、MMDAgent-EX には「口パク」だけさせる方法です。外部プロセスでリップシンク用のメッセージ **LYPSYNC_START** を作成し、音声を再生するタイミングに合わせて MMDAgent-EX に送ります。

**LIPSYNC_START** メッセージはリップシンクの実行を指示するメッセージです。第1引数は対象とするモデルのエイリアス名、第2引数がリップシンクの内容です。内容は、音素名および持続時間（単位はミリ秒）の列をカンマ区切りで指定します。

{{<message>}}
LIPSYNC_START|gene|sil,187,k,75,o,75,N,75,n,75,i,62,ch,75,i,87,w,100,a,87,sil,212
{{</message>}}

デフォルトで使える音素名は、Open JTalk で用いられている音素セットです。これは「リップシンク定義ファイル」を編集することで容易に変更・拡張可能です。

{{< details "リップシンク定義ファイルについて" close >}}

音素名の定義および各音素名からキャラクターのモーフへの変換規則が、MMDAgent-EX の実行ファイルがあるディレクトリの `AppData` フォルダ以下のファイル `lip.txt` で定義されています。一部を以下に示します。デフォルトでは Open JTalk の音素セットに対して「あ」「い」「う」「お」の4つのモーフの重み付き結合として表現するよう定義されています。これを編集、あるいは音素を追加することで、任意の音素列・モーフに拡張できます。

```text
# number of expressions
4
# expression names
あ
い
う
お
# number of phonemes
69
# phone names and interpolation weight
A   0.2 0.0 0.0 0.0
E   0.1 0.3 0.1 0.0
I   0.0 0.2 0.0 0.0
N   0.0 0.0 0.0 0.0
O   0.0 0.0 0.0 0.2
U   0.0 0.0 0.2 0.0
a   0.5 0.0 0.0 0.0
...
```

{{< /details >}}

MMDAgent-EX は **LIPSYNC_START** で送られた音素列を定義に従ってモーションに変換し、指定モデル上で再生を開始します。リップシンク開始時に **LIPSYNC_EVENT_START** が、終了時に **LIPSYNC_EVENT_STOP** が発行されます。

{{<message>}}
LIPSYNC_EVENT_START|(model alias)
LIPSYNC_EVENT_STOP|(model alias)
{{</message>}}

**LIPSYNC_STOP** で途中で中断もできます。

{{<message>}}
LIPSYNC_STOP|(model alias)
{{</message>}}

この方法の外部プロセスから見たメリット・デメリットです。

メリット：

- 再生が自前なので音声クオリティや再生デバイス等の MMDAgent-EX の仕様に制約されない
- リップシンク内容を制御できる
- 拡張性が高い

デメリット：

- 音素列と持続時間情報からリップシンク情報を自前で作成する必要がある
