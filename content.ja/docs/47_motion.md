---
title: 動作の制御
slug: motion
---
# 動作の制御

MMDAgent-EX のモデル表示および動作の制御は MikuMikuDance の仕様をベースとして拡張したものになっています。ここでは、動作制御の基本的な仕組みを説明します。

## 動作制御の仕組み

動く3Dモデルは、頂点・面・材質・テクスチャといった見た目の情報だけでなく、それらを動かすための「ボーン」と「モーフ」が内部で定義されています。
そして、動作時にそれらモデル内の「ボーン」「モーフ」をどのタイミングでどう動かすかの一連の定義を「モーション」と呼びます。

{{< hint info >}}
用途やツールによって呼び名はさまざまで、もっと多様な情報を持つ3Dモデルもありますが、ここでは MikuMikuDance に倣い「ボーン」と「モーフ」のみを扱います。
{{< /hint >}}

MMDAgent-EX は、表示したモデルに対してモーションを実行することで、一連の動きを再生します。

以下、MMDAgent-EX における定義と扱いについて簡単に説明します。

### ボーンとは

ボーンはモデル全体や一部を移動・回転させるための操作点です。1つのモデルには、少ないときで数個、人型のモデルだと人体の可動箇所を模擬するために数十個のボーンが定義されます。各ボーンに対して追従動作すべき表示点（頂点・面）が定義されており、ボーンを移動・回転させることで関連付けられたパーツが動きます。

また多くの場合、ボーンは親ボーンを持ちます。親ボーンがある場合、親ボーンの動きは小ボーンへ伝搬されます。この階層構造は手足のような多関節の動きを再現するために必要な仕組みです。

ボーンの動きは「キーフレームベース」で定義されます。特定の時間（キーフレーム）における位置・回転量のみを定義しておき、動作時には間のフレームは自動的に補間計算されます。

### モーフとは

モーフは「変形」を意味する言葉で、3Dモデルにおいてはパーツの変形パターンを定義するものです。初期状態と変形後の状態を定義し、実行時にはその「変化量」を 0.0から 1.0 の値で与えることで、一方から他方へ変形していく様子を自動的に生成します。主に表情の変化に用いられるほか、部位の変形等に用いられます。対話用の人型3Dモデルでは通常数十種類の表情に対応するモーフが定義されています。複数のモーフを組み合わせて動作させることで複雑な表情や表現を作り出します。

1つのモーフは、対象のモデルパラメータ集合とそれらの変形後の値で構成されます。頂点を移動させてモデルを変化させる「頂点モーフ」が基本ですが、ボーンの位置を移動させる「ボーンモーフ」、テクスチャ座標を移動してテクスチャを変化させる「UVモーフ」、透過度や色等の材質情報を変更させる「材質モーフ」等も存在します。さらに、使いやすさのために複数のモーフを束ねて1つのパラメータで動作できるようにする「グループモーフ」もあります。

モーフはボーンと同じくキーフレームベースで動作定義します。キーフレームごとにモーフの変化量（0.0から1.0）を指定します。実行時は、キーフレーム間では自動的に補間計算されます。

## モーションファイル(.vmd)

モーションファイル (.vmd) は3Dモデルがどう動くかを定義するファイルです。1つの .vmd ファイルには、動作対象とするボーン・モーフの名称とキーフレーム集合が入っています。

3Dモデルでモーションを再生する際は、最初にモーションファイルにあるボーン・モーフの名前がモデルのボーン・モーフ名リストと称号され、合致するボーン・モーフがある場合にのみそのモーションが適用されます。
