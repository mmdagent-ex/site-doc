# 自動更新のしくみ

## コンテンツ

Webコンテンツを再生時は、起動後すぐにサーバの内容と比較チェックが行われ、サーバ側が新しい場合は自動更新がかかる。

自動更新がかかるのは以下のケース：

1. 起動時に "mmdagent://..." あるいは　"https://..." のようにコンテンツ URL を直接指定して起動したとき。この場合、指定サイトからダウンロードが行われてからコンテンツが起動する。以前その端末で再生したことがあるURLの場合は、差分のみがダウンロードされる。コンテンツはローカルのコンテンツフォルダ（デスクトップの MMDAgent-Content 以下）に保存されている。
2. ホームやブックマーク、あるいはコンテンツフォルダ内の .mdf を直接指定するなどで、「以前Webからダウンロードしたことのあるコンテンツ」（例えばデスクトップの MMDAgent-Content以下のコンテンツ等）を起動したとき。この場合、起動後数秒してから自動的に更新チェックがバックグラウンドで走り、再生中のコンテンツに更新がある場合はその場で強制シャットダウンからの差分更新と再起動が行われる。

### 自動更新をONにするには

Webコンテンツは自動的にＯＮになる。

具体的には、MMDAgent-EX はコンテンツのトップフォルダに .mmdagent-save があり、その中にソースのURLが保持されているかどうかで自動更新するかどうかを判定している。Webからコンテンツを取得・更新したとき、MMDAgent-EX はこの .mmdagent-save を保存する。次回更新時に .mdf と同じフォルダに .mmdagent-save があればそこに書かれているソースのURLに向かって自動更新が走る。

### 強制更新

以前Webからダウンロードしたことのあるコンテンツを起動しても自動更新がかからない場合は、リロードするか、元ソースのWebコンテンツをもういちど直接指定して起動すれば強制更新がかかる。

### 更新をやめる

MMDAgent-Content フォルダからフォルダを移動させて .mmdagent-save を消せば自動更新はされなくなる。

## 実行ファイル

あるマシンにある実行ファイル群（MMDAgent-EX.exe、Plugins, DLLs, AppData といった "Release" フォルダ以下にあるもの）をWebサイトにあるものに自動同期させることができる。

### しくみの解説

MMDAgent-EX.exe は起動して数秒立ったときにその .exe と同じフォルダに "site" というテキストファイルがあるかどうかを調べ、そのファイルがあれば、その中の最初の1行に書かれているURLを .exe を含むバイナリディレクトリのマスターが置いてある場所としてアクセスを行い、差分更新を行う。

1. サーバからファイル一覧および最終更新されたタイムスタンプを持つインデックスファイル .mmdagent-content-files をダウンロードしてローカルに保存。
2. そのタイムスタンプと .mmdagent-save に保存されている情報を突き合わせる
3. ローカルよりサーバにあるほうが新しければ、保存されたファイル一覧とローカルのサブディレクトリの内容を比較して、新規ファイルあるいは更新ファイルをダウンロードする。またローカルにあるが保存されたファイル一覧にないファイルを削除する。
4. .exe ファイル自身については自己上書きができないため更新できない。このように上書き更新できなかったファイルは _updating を付けたファイル名で一時保存される。以下のようなバッチスクリプトを run_updater.bat として .exe と同じディレクトリに置いておけば、一時保存 → MMDAgent-EX 終了＋スクリプト起動 → スクリプトが .exe 書き換え → MMDAgent-EX 再起動、ができる。

```text
@echo off
setlocal enabledelayedexpansion

timeout /nobreak 3

set "base_dir=."

for /R "%base_dir%" %%F in (*_updating) do (
    set "full_path=%%F"
    set "new_path=!full_path:_updating=!"

    echo Copying !full_path! to !new_path!
    copy "!full_path!" "!new_path!" /Y
)

cd /D %1
shift

set "cmd=%1"

echo Running command:!cmd!
call !cmd!

endlocal

```

注意：このように遠隔で .exe を書き換える仕組みは言うまでもなく強烈なセキュリティホールになりうる。自己責任で使うこと。

### 自動更新をONにするには

.exe のあるフォルダと同じフォルダに "site" という名前の（拡張子無しの）テキストファイルを作り、
その1行目に、URLを書く。URLは MMDAgent のWebコンテンツと同様に mit.py によるインデックスがあることが前提。

### 強制更新

起動時の自動検出→自動更新がうまくかからない場合や、すでに起動しているMMDAgent-EXを更新する場合は 「!」キーで強制更新を促すことができる。

あるいは .exe フォルダに保存されている .mmdagent-save ファイルを削除して再起動するのでも同様の効果が得られる。

### 更新をやめる

site ファイルを消せば更新は行われない
